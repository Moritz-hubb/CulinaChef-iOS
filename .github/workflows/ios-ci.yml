name: iOS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Linting
  lint:
    name: SwiftLint
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging
        continue-on-error: true  # Warnung, aber kein Fehler

  # Job 2: Build & Test
  build-and-test:
    name: Build & Test
    runs-on: macos-14  # Xcode 15+
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Show Xcode Version
        run: xcodebuild -version
      
      - name: Install XcodeGen
        run: brew install xcodegen
      
      - name: Create Secrets.xcconfig (Mock for CI)
        run: |
          cat > Configs/Secrets.xcconfig << EOF
          OPENAI_API_KEY = CI_MOCK_KEY
          SENTRY_DSN = 
          EOF
      
      - name: Generate Xcode Project
        run: ./gen.sh
      
      - name: Build App
        run: |
          xcodebuild build \
            -project CulinaChef.xcodeproj \
            -scheme CulinaChef \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -project CulinaChef.xcodeproj \
            -scheme CulinaChef \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true  # Tests k√∂nnen fehlschlagen, bis sie implementiert sind
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/Logs/Test/*.xcresult
          retention-days: 7
      
      - name: Generate Code Coverage Report
        if: success()
        run: |
          xcrun xccov view --report --json DerivedData/*/Logs/Test/*.xcresult > coverage.json
        continue-on-error: true
      
      - name: Upload Coverage
        if: success()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.json
          flags: ios
          name: ios-coverage
        continue-on-error: true

  # Job 3: Security Checks
  security:
    name: Security Scan
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Check for Secrets in Code
        run: |
          echo "üîç Checking for hardcoded secrets..."
          
          # Check for common secret patterns
          if grep -r -E "(api[_-]?key|apikey|secret|password|token|bearer)\s*=\s*['\"]([^'\"]{20,})" Sources/; then
            echo "‚ö†Ô∏è  Potential hardcoded secrets found!"
            exit 1
          fi
          
          # Check if Secrets.xcconfig is not committed
          if git ls-files | grep -q "Configs/Secrets.xcconfig"; then
            echo "‚ùå Secrets.xcconfig should not be committed!"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets detected"
      
      - name: Check for Debug Logs with Sensitive Data
        run: |
          echo "üîç Checking for unsafe debug logs..."
          
          # Look for print() statements with potential sensitive data
          if grep -r -n "print.*token\|print.*password\|print.*key\|print.*secret" Sources/ | grep -v "#if DEBUG"; then
            echo "‚ö†Ô∏è  Potential sensitive data in logs without DEBUG guard!"
          fi
          
          echo "‚úÖ Log safety check completed"
        continue-on-error: true

  # Job 4: Code Quality Metrics
  metrics:
    name: Code Metrics
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Count Lines of Code
        run: |
          echo "üìä Code Statistics:"
          echo "Total Swift files: $(find Sources -name '*.swift' | wc -l)"
          echo "Total lines of code: $(find Sources -name '*.swift' -exec cat {} \; | wc -l)"
          echo ""
          echo "Files by category:"
          echo "Views: $(find Sources/Views -name '*.swift' 2>/dev/null | wc -l)"
          echo "Services: $(find Sources/Services -name '*.swift' 2>/dev/null | wc -l)"
          echo "Models: $(find Sources/Models -name '*.swift' 2>/dev/null | wc -l)"
      
      - name: Check TODO Comments
        run: |
          echo "üìù TODO/FIXME Comments:"
          grep -r -n "TODO\|FIXME" Sources/ || echo "No TODOs found"
        continue-on-error: true
